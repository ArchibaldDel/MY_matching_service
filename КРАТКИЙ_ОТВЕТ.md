# ‚úÖ –ö–†–ê–¢–ö–ò–ô –û–¢–í–ï–¢ –ù–ê –í–ê–®–ò –í–û–ü–†–û–°–´

## –í–æ–ø—Ä–æ—Å 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å, –Ω–µ –º–µ–Ω—è—è –ª–æ–≥–∏–∫—É SQL

### ‚úÖ –û–¢–í–ï–¢: –õ–æ–≥–∏–∫–∞ –ù–ï –∏–∑–º–µ–Ω–µ–Ω–∞

–í—Å–µ 6 SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–π –ª–æ–≥–∏–∫–µ:

| –û—Ç—á—ë—Ç | –ò—Å—Ö–æ–¥–Ω–∞—è –ª–æ–≥–∏–∫–∞ | –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ |
|-------|-----------------|-------------------|
| payments | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | `CASE WHEN` ‚Üí `countIf/sumIf` (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç) |
| users | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | `ANY()` ‚Üí `has()` (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç) |
| packages-by-tariff | ‚ö†Ô∏è **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞** | `now()` ‚Üí `dr.day` ‚úÖ |
| packages-by-period | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | –õ–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç |
| mg_churn | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã |
| event_backend | ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | UNION ALL –≤—Å–µ—Ö 4 —Å–æ–±—ã—Ç–∏–π |

### ‚ùó –ù–∞–π–¥–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ 1 –æ—à–∏–±–∫–∞:

**–í –∑–∞–ø—Ä–æ—Å–µ `packages-by-tariff`:**
```sql
-- ‚ùå –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
WHERE upp.startDate < now() AND upp.endDate > now()

-- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
WHERE upp.startDate < dr.day AND upp.endDate > dr.day
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å—á–∏—Ç–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –Ω–∞ –ö–ê–ñ–î–´–ô –¥–µ–Ω—å –∏–∑ `generate_series`, –∞ –Ω–µ –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ñ–∞–π–ª–µ `clickhouse_mg_reporting_schema.sql`

---

## –í–æ–ø—Ä–æ—Å 2: –ì–¥–µ –ø—Ä–æ–≥–Ω–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∫–∞–∫–∏–µ –ø–æ–ª—è –Ω—É–∂–Ω—ã –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –¥–ª—è MV?

### ‚úÖ –û–¢–í–ï–¢: –ü—Ä–æ–≥–Ω–∞—Ç—å –≤ PostgreSQL

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. **–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª:** `LOGIC_VALIDATION_AND_TEST_QUERIES.md`

2. **–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ 6 –æ—Ç—á—ë—Ç–æ–≤** –Ω–∞–π—Ç–∏ —Å–µ–∫—Ü–∏—é **"üéØ –ì–¥–µ –ø—Ä–æ–≥–Ω–∞—Ç—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã"**

3. **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π SQL-–∑–∞–ø—Ä–æ—Å** –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ **PostgreSQL** —Å `LIMIT 5-10`

4. **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –∏ –∏—Ö —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

5. **–°–≤–µ—Ä–∏—Ç—å —Å –≤–∏—Ç—Ä–∏–Ω–æ–π ClickHouse** (`mg_dm.*`) - —Ç–∏–ø—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å

### –ü—Ä–∏–º–µ—Ä –¥–ª—è –æ—Ç—á—ë—Ç–∞ `payments`:

#### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ PostgreSQL
```sql
with t as (
    select
        ("updated" at time zone 'MSK')::date event_date,
        count(case when "purposeOfPayment" <> 'refund' then id end) total_payment_attempts,
        count(case when "purposeOfPayment" <> 'refund' and state = 'completed' then id end) completed_payments,
        count(case when "purposeOfPayment" = 'refund' and state = 'completed' then id end) refunds,
        sum(case when "purposeOfPayment" <> 'refund' and state = 'completed' 
            then "amount" end) total_revenue,
        sum(case when state = 'completed' 
            and "purposeOfPayment" in ('upgradeTariffPackage', 'upsaleTariffPackage', 'buyTariffPackage', 'buyTariffAndAdditionalPackages') 
            then "amount" else 0 end) tariff_revenue,
        sum(case when state = 'completed' and "purposeOfPayment" in ('buyAdditionalPackages') 
            then "amount" else 0 end) ap_revenue,
        sum(case when "purposeOfPayment" = 'refund' and state = 'completed' 
            then -"amount" else 0 end) refund_amount
    from  "Payments" p
    WHERE p.state <> 'split' 
        AND ("updated" at time zone 'MSK')::date >= '2024-01-01'
        and p."source"  = 'marketguru'
    group by 1
)
select * from t LIMIT 5;
```

#### –®–∞–≥ 2: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ç–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫
```
–ö–æ–ª–æ–Ω–∫–∞                 | –¢–∏–ø –≤ PostgreSQL
-----------------------|------------------
event_date             | date
total_payment_attempts | bigint
completed_payments     | bigint
refunds                | bigint
total_revenue          | numeric(12,2)
tariff_revenue         | numeric(12,2)
ap_revenue             | numeric(12,2)
refund_amount          | numeric(12,2)
```

#### –®–∞–≥ 3: –°–≤–µ—Ä–∏—Ç—å —Å –≤–∏—Ç—Ä–∏–Ω–æ–π ClickHouse
```sql
-- –í —Ñ–∞–π–ª–µ clickhouse_mg_reporting_schema.sql:
CREATE TABLE mg_dm.payments_daily (
    event_date             Date,          -- ‚úÖ date ‚Üí Date
    total_payment_attempts UInt64,        -- ‚úÖ bigint ‚Üí UInt64
    completed_payments     UInt64,        -- ‚úÖ bigint ‚Üí UInt64
    refunds                UInt64,        -- ‚úÖ bigint ‚Üí UInt64
    total_revenue          Decimal(18,2), -- ‚úÖ numeric ‚Üí Decimal (—É–≤–µ–ª–∏—á–µ–Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å)
    tariff_revenue         Decimal(18,2), -- ‚úÖ numeric ‚Üí Decimal
    ap_revenue             Decimal(18,2), -- ‚úÖ numeric ‚Üí Decimal
    refund_amount          Decimal(18,2)  -- ‚úÖ numeric ‚Üí Decimal
);
```

#### –®–∞–≥ 4: –ï—Å–ª–∏ —Ç–∏–ø—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç - –∏—Å–ø—Ä–∞–≤–∏—Ç—å
–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤ PostgreSQL `total_revenue` –∏–º–µ–µ—Ç —Ç–∏–ø `numeric(24,2)`, —Ç–æ –≤ ClickHouse –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ `Decimal(24,2)`.

### üìä –ì–¥–µ –Ω–∞–π—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤—Å–µ—Ö 6 –æ—Ç—á—ë—Ç–æ–≤:

–í—Å–µ –≥–æ—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ñ–∞–π–ª–µ **`LOGIC_VALIDATION_AND_TEST_QUERIES.md`**:

- **Payments** - —Å—Ç—Ä–æ–∫–∏ ~50-100
- **Users** - —Å—Ç—Ä–æ–∫–∏ ~110-150
- **Packages-by-tariff** - —Å—Ç—Ä–æ–∫–∏ ~160-210
- **Packages-by-period** - —Å—Ç—Ä–æ–∫–∏ ~220-280
- **MG_churn** - —Å—Ç—Ä–æ–∫–∏ ~290-350
- **Event_backend** - —Å—Ç—Ä–æ–∫–∏ ~360-410

### üìã –ö—Ä–∞—Ç–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞: —á—Ç–æ –≥–¥–µ –ø—Ä–æ–≥–Ω–∞—Ç—å

| –û—Ç—á—ë—Ç | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | –§–∞–π–ª —Å –∑–∞–ø—Ä–æ—Å–æ–º | –°–µ–∫—Ü–∏—è |
|-------|-------------|-----------------|--------|
| payments | PostgreSQL | LOGIC_VALIDATION_AND_TEST_QUERIES.md | 1Ô∏è‚É£ |
| users | PostgreSQL | LOGIC_VALIDATION_AND_TEST_QUERIES.md | 2Ô∏è‚É£ |
| packages-by-tariff | PostgreSQL | LOGIC_VALIDATION_AND_TEST_QUERIES.md | 3Ô∏è‚É£ |
| packages-by-period | PostgreSQL | LOGIC_VALIDATION_AND_TEST_QUERIES.md | 4Ô∏è‚É£ |
| mg_churn | PostgreSQL | LOGIC_VALIDATION_AND_TEST_QUERIES.md | 5Ô∏è‚É£ |
| event_backend | PostgreSQL | LOGIC_VALIDATION_AND_TEST_QUERIES.md | 6Ô∏è‚É£ |

---

## üìÅ –ò—Ç–æ–≥–æ–≤—ã–µ —Ñ–∞–π–ª—ã

–Ø —Å–æ–∑–¥–∞–ª –¥–ª—è –≤–∞—Å **7 —Ñ–∞–π–ª–æ–≤**:

### 1. `clickhouse_mg_reporting_schema.sql` ‚≠ê
**–û—Å–Ω–æ–≤–Ω–æ–π SQL-—Å–∫—Ä–∏–ø—Ç** –¥–ª—è ClickHouse —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–æ–π.
- –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö (mg_raw, mg_dm, mg_mv)
- RAW-—Ç–∞–±–ª–∏—Ü—ã (6 —à—Ç—É–∫)
- –í–∏—Ç—Ä–∏–Ω—ã (6 —à—Ç—É–∫)
- –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (2 —à—Ç—É–∫–∏)

### 2. `LOGIC_VALIDATION_AND_TEST_QUERIES.md` ‚≠ê
**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ + –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü.**
- –î–µ—Ç–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ PG vs CH
- –ì–æ—Ç–æ–≤—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ PostgreSQL
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

### 3. `FIELD_MAPPING_TABLE.md` ‚≠ê
**–¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ–ª–µ–π PostgreSQL ‚Üí ClickHouse.**
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –ø–æ–∫–∞–∑–∞–Ω–æ: –∫–∞–∫–∏–µ –ø–æ–ª—è –∏–∑ –∫–∞–∫–∏—Ö —Ç–∞–±–ª–∏—Ü –±–µ—Ä—É—Ç—Å—è
- –ú–∞–ø–ø–∏–Ω–≥ RAW ‚Üí DM
- –ì–¥–µ –ø—Ä–æ–≥–Ω–∞—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### 4. `validation_report.md`
–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π –∏ —Å—Ö–µ–º—ã –ë–î.

### 5. `README_CLICKHOUSE_SETUP.md`
–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –±—ã—Å—Ç—Ä–æ–º—É —Å—Ç–∞—Ä—Ç—É –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.

### 6. `FINAL_CHECKLIST.md`
–ß–µ–∫–ª–∏—Å—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ ClickHouse.

### 7. `–†–ï–ó–Æ–ú–ï.md`
–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤—Å–µ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

---

## üéØ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ (–ø–æ—à–∞–≥–æ–≤–æ)

### –®–ê–ì 1: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü
1. –û—Ç–∫—Ä—ã—Ç—å `LOGIC_VALIDATION_AND_TEST_QUERIES.md`
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ PostgreSQL (6 –∑–∞–ø—Ä–æ—Å–æ–≤)
3. –ó–∞–ø–∏—Å–∞—Ç—å —Ç–∏–ø—ã –∫–æ–ª–æ–Ω–æ–∫

### –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ PostgreSQL:
   ```sql
   -- –ö–∞–∫–æ–µ –ø–æ–ª–µ: type –∏–ª–∏ sourceType?
   SELECT column_name FROM information_schema.columns 
   WHERE table_name = 'user_permission_packages' 
   AND column_name IN ('type', 'sourceType');
   
   -- –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ MSK?
   SELECT now() AT TIME ZONE 'MSK';
   
   -- –û–±—ä—ë–º—ã –¥–∞–Ω–Ω—ã—Ö
   SELECT COUNT(*) FROM users WHERE 'marketguru' = ANY(source);
   ```

### –®–ê–ì 3: –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
1. –û—Ç–∫—Ä—ã—Ç—å `clickhouse_mg_reporting_schema.sql`
2. –ù–∞–π—Ç–∏ —Å–µ–∫—Ü–∏—é "–°–ï–ö–¶–ò–Ø 3: DM-–°–õ–û–ô"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤ –∏–∑ –®–∞–≥–∞ 1
4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### –®–ê–ì 4: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –≤ ClickHouse
```bash
clickhouse-client --host <host> --user <user> < clickhouse_mg_reporting_schema.sql
```

### –®–ê–ì 5: –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
–°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `README_CLICKHOUSE_SETUP.md`

### –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
–°—Ä–∞–≤–Ω–∏—Ç—å COUNT –∏ SUM –º–µ–∂–¥—É PostgreSQL –∏ ClickHouse.

---

## ‚úÖ –ò–¢–û–ì–û

### –í–æ–ø—Ä–æ—Å 1: –õ–æ–≥–∏–∫–∞ SQL –∏–∑–º–µ–Ω–µ–Ω–∞?
**–û—Ç–≤–µ—Ç:** ‚ùå –ù–ï–¢, –ª–æ–≥–∏–∫–∞ –ù–ï –∏–∑–º–µ–Ω–µ–Ω–∞ (–∫—Ä–æ–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω–Ω–æ–π –æ—à–∏–±–∫–∏ –≤ packages-by-tariff)

### –í–æ–ø—Ä–æ—Å 2: –ì–¥–µ –ø—Ä–æ–≥–Ω–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è MV?
**–û—Ç–≤–µ—Ç:** ‚úÖ –í PostgreSQL, –∏—Å–ø–æ–ª—å–∑—É—è –≥–æ—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ `LOGIC_VALIDATION_AND_TEST_QUERIES.md`

### –°—Ç–∞—Ç—É—Å:
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

---

**–£—Å–ø–µ—Ö–æ–≤ —Å –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ–º! üöÄ**

