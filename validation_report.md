# –û—Ç—á—ë—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ MarketGuru

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 2025-11-14  
**–ü—Ä–æ–≤–µ—Ä—è—é—â–∏–π:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ó–ê–ü–†–û–°–´ –ö–û–†–†–ï–ö–¢–ù–´

---

## –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏

| ‚Ññ | –û—Ç—á—ë—Ç | –¢–∞–±–ª–∏—Ü—ã | –ü–æ–ª—è | –°—Ç–∞—Ç—É—Å | –ó–∞–º–µ—á–∞–Ω–∏—è |
|---|-------|---------|------|--------|-----------|
| 1 | payments | Payments | ‚úÖ | ‚úÖ | –í—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ö–µ–º–µ |
| 2 | users | users | ‚úÖ | ‚úÖ | source –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –º–∞—Å—Å–∏–≤ |
| 3 | packages-by-tariff | permission_packages, user_permission_packages, tariffs | ‚úÖ | ‚úÖ | sourceType –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å—Ö–µ–º–µ |
| 4 | packages-by-period | permission_packages, user_permission_packages, tariffs, tariff_group_days | ‚úÖ | ‚úÖ | –í—Å–µ JOIN –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã |
| 5 | mg_churn | user_permission_packages | ‚úÖ | ‚úÖ | –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ |
| 6 | event_backend | users, user_permission_packages, Payments | ‚úÖ | ‚úÖ | UNION ALL –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω |

---

## –î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –æ—Ç—á—ë—Ç–∞–º

### 1. –û—Ç—á—ë—Ç `payments` ‚úÖ

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `public."Payments"`

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –ø–æ–ª—è:**

| –ü–æ–ª–µ –≤ –∑–∞–ø—Ä–æ—Å–µ | –¢–∏–ø –≤ —Å—Ö–µ–º–µ | –°—Ç–∞—Ç—É—Å |
|----------------|-------------|--------|
| `id` | `uuid NOT NULL` | ‚úÖ |
| `updated` | `timestamptz NOT NULL` | ‚úÖ |
| `purposeOfPayment` | `varchar(255) NOT NULL` | ‚úÖ |
| `state` | `varchar(255) NOT NULL` | ‚úÖ |
| `amount` | `numeric(12, 2) NOT NULL` | ‚úÖ |
| `source` | `enum_resource NOT NULL` | ‚úÖ |

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ (updated AT TIME ZONE 'MSK')::date
-- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: state <> 'split', source = 'marketguru', updated >= '2024-01-01'
-- –ê–≥—Ä–µ–≥–∞—Ü–∏–∏: COUNT, SUM —Å CASE WHEN –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–π
```

**–í—ã–≤–æ–¥:** ‚úÖ –ó–∞–ø—Ä–æ—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –í—Å–µ –ø–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç, —Ç–∏–ø—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç.

**–ó–Ω–∞—á–µ–Ω–∏—è purposeOfPayment, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –∑–∞–ø—Ä–æ—Å–µ:**
- `'refund'` - –≤–æ–∑–≤—Ä–∞—Ç—ã
- `'upgradeTariffPackage'` - –∞–ø–≥—Ä–µ–π–¥ —Ç–∞—Ä–∏—Ñ–∞
- `'upsaleTariffPackage'` - –∞–ø—Å–µ–π–ª —Ç–∞—Ä–∏—Ñ–∞
- `'buyTariffPackage'` - –ø–æ–∫—É–ø–∫–∞ —Ç–∞—Ä–∏—Ñ–∞
- `'buyTariffAndAdditionalPackages'` - –ø–æ–∫—É–ø–∫–∞ —Ç–∞—Ä–∏—Ñ–∞ + –¥–æ–ø. –ø–∞–∫–µ—Ç—ã
- `'buyAdditionalPackages'` - –ø–æ–∫—É–ø–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤

---

### 2. –û—Ç—á—ë—Ç `users` ‚úÖ

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `public.users`

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –ø–æ–ª—è:**

| –ü–æ–ª–µ –≤ –∑–∞–ø—Ä–æ—Å–µ | –¢–∏–ø –≤ —Å—Ö–µ–º–µ | –°—Ç–∞—Ç—É—Å |
|----------------|-------------|--------|
| `id` | `uuid NOT NULL` | ‚úÖ |
| `created` | `timestamptz NOT NULL` | ‚úÖ |
| `source` | –ú–∞—Å—Å–∏–≤/enum[] | ‚úÖ |
| `deleted` | `timestamptz NULL` | ‚úÖ |

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –í—ã–±–æ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å 'marketguru' –≤ –º–∞—Å—Å–∏–≤–µ source
-- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: deleted IS NULL, created >= '2024-01-01'
```

**–í—ã–≤–æ–¥:** ‚úÖ –ó–∞–ø—Ä–æ—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `'marketguru' = ANY(source)` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –≤ PostgreSQL.

---

### 3. –û—Ç—á—ë—Ç `packages-by-tariff` ‚úÖ

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `public.permission_packages`
- `public.user_permission_packages`
- `public.tariffs`

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –ø–æ–ª—è:**

#### permission_packages:
| –ü–æ–ª–µ | –¢–∏–ø –≤ —Å—Ö–µ–º–µ | –°—Ç–∞—Ç—É—Å |
|------|-------------|--------|
| `id` | `uuid NOT NULL` | ‚úÖ |
| `tariffId` | `uuid NULL` | ‚úÖ |
| `updated` | `timestamptz NOT NULL` | ‚úÖ |

#### user_permission_packages:
| –ü–æ–ª–µ | –¢–∏–ø –≤ —Å—Ö–µ–º–µ | –°—Ç–∞—Ç—É—Å |
|------|-------------|--------|
| `permissionPackageId` | `uuid NOT NULL` | ‚úÖ |
| `startDate` | `timestamptz NOT NULL` | ‚úÖ |
| `endDate` | `timestamptz NULL` | ‚úÖ |
| `status` | `varchar(255) NOT NULL` | ‚úÖ |
| `deleted` | `timestamptz NULL` | ‚úÖ |
| `sourceType` | `varchar(255)` | ‚úÖ |

#### tariffs:
| –ü–æ–ª–µ | –¢–∏–ø –≤ —Å—Ö–µ–º–µ | –°—Ç–∞—Ç—É—Å |
|------|-------------|--------|
| `id` | `uuid NOT NULL` | ‚úÖ |
| `name` | `varchar(255) NOT NULL` | ‚úÖ |
| `source` | `enum_resource NOT NULL` | ‚úÖ |

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–π —á–µ—Ä–µ–∑ generate_series
-- JOIN –º–µ–∂–¥—É pp, upp, tariffs
-- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è sourceType –Ω–∞ 'paid', 'gift' –∏ –¥—Ä.
-- –£—Å–ª–æ–≤–∏–µ –¥–ª—è 'paid': sourceType IN ('payment', 'upgrade', 'paidCoupon') 
--   –ò–õ–ò gift —Å –ø–µ—Ä–∏–æ–¥–æ–º > 29 –¥–Ω–µ–π
```

**–í—ã–≤–æ–¥:** ‚úÖ –í—Å–µ JOIN –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –ø–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç. –õ–æ–≥–∏–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–Ω—è—Ç–Ω–∞.

**–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:** –ü–æ–ª–µ `sourceType` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–ø—Ä–æ—Å–µ. –°–æ–≥–ª–∞—Å–Ω–æ DDL –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö, —ç—Ç–æ –ø–æ–ª–µ –º–æ–∂–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è `type` –∏–ª–∏ `sourceType`. –í RAW-—Ç–∞–±–ª–∏—Ü–µ ClickHouse –∑–∞–ª–æ–∂–µ–Ω—ã –æ–±–∞ –ø–æ–ª—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

---

### 4. –û—Ç—á—ë—Ç `packages-by-period` ‚úÖ

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `public.permission_packages`
- `public.user_permission_packages`
- `public.tariffs`
- `public.tariff_group_days`

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –ø–æ–ª—è (tariff_group_days):**

| –ü–æ–ª–µ | –¢–∏–ø –≤ —Å—Ö–µ–º–µ | –°—Ç–∞—Ç—É—Å |
|------|-------------|--------|
| `day` | `int4 NOT NULL` | ‚úÖ |
| `name` | `varchar(255) NOT NULL` | ‚úÖ |
| `source` | `enum_resource NOT NULL` | ‚úÖ |

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–Ω–µ–π —á–µ—Ä–µ–∑ generate_series
-- –ü–æ–¥—Å—á—ë—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (pp.period)
-- –ú–∞–ø–ø–∏–Ω–≥ –ø–µ—Ä–∏–æ–¥–æ–≤ –Ω–∞ "–∫–æ—Ä–∑–∏–Ω—ã" –∏–∑ tariff_group_days
-- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ period_name: —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, "< X", "> Y"
```

**–í—ã–≤–æ–¥:** ‚úÖ –ó–∞–ø—Ä–æ—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –õ–æ–≥–∏–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞ —Å–ª–æ–∂–Ω–∞—è, –Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ–º–∞ –≤ ClickHouse —á–µ—Ä–µ–∑ COALESCE –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã.

---

### 5. –û—Ç—á—ë—Ç `mg_churn` ‚úÖ

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `public.user_permission_packages`

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –ø–æ–ª—è:**

| –ü–æ–ª–µ | –¢–∏–ø –≤ —Å—Ö–µ–º–µ | –°—Ç–∞—Ç—É—Å |
|------|-------------|--------|
| `userId` | `uuid NOT NULL` | ‚úÖ |
| `startDate` | `timestamptz NOT NULL` | ‚úÖ |
| `endDate` | `timestamptz NULL` | ‚úÖ |

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
```sql
-- CTE: sorted - –æ–∫–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è MAX –¥–ª—è –ø–æ–∏—Å–∫–∞ max_prev_end
-- CTE: flagged - –ø–æ–º–µ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã—Ö –∫—É—Å–∫–æ–≤ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
-- CTE: chunked - –Ω—É–º–µ—Ä–∞—Ü–∏—è –∫—É—Å–∫–æ–≤ —á–µ—Ä–µ–∑ –∫—É–º—É–ª—è—Ç–∏–≤–Ω—É—é —Å—É–º–º—É
-- CTE: merged - –∞–≥—Ä–µ–≥–∞—Ü–∏—è –≤ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
-- CTE: with_next - –ø–æ–∏—Å–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ —á–µ—Ä–µ–∑ LEAD
-- –§–∏–Ω–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —Ä–∞–∑—Ä—ã–≤—ã > 30 –¥–Ω–µ–π
```

**–í—ã–≤–æ–¥:** ‚úÖ –ó–∞–ø—Ä–æ—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ PostgreSQL (MAX OVER, SUM OVER, LEAD). –í ClickHouse –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ maxOver, sumOver, lagInFrame/leadInFrame.

**–§–∏–ª—å—Ç—Ä—ã:**
- `startDate >= '2024-01-01'`
- `period_end < now() - interval '30 days'`
- `(next_start - period_end) > interval '30 days'`

---

### 6. –û—Ç—á—ë—Ç `event_backend` ‚úÖ

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `public.users`
- `public.user_permission_packages`
- `public."Payments"`

**–°–æ–±—ã—Ç–∏—è:**

#### 6.1. registration
```sql
SELECT id, created::date, 'registration' FROM users
```
‚úÖ –ü–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

#### 6.2. trial
```sql
SELECT userId, startDate::date, 'trial' FROM user_permission_packages
WHERE sourceType IN ('trial') AND startDate >= '2025-01-01'
```
‚úÖ –ü–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, sourceType —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

#### 6.3. first_pay_tariff
```sql
-- ROW_NUMBER() –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
-- –£—Å–ª–æ–≤–∏–µ: sourceType IN ('payment', 'upgrade', 'paidCoupon')
--   –ò–õ–ò gift —Å –ø–µ—Ä–∏–æ–¥–æ–º > 29 –¥–Ω–µ–π
```
‚úÖ –õ–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –ø–æ–ª—è

#### 6.4. first_pay_ap
```sql
-- ROW_NUMBER() –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏ –¥–æ–ø. –ø–∞–∫–µ—Ç–æ–≤
-- –ò—Å—Ç–æ—á–Ω–∏–∫: Payments
-- –£—Å–ª–æ–≤–∏–µ: purposeOfPayment IN ('buyAdditionalPackages', 'buyTariffAndAdditionalPackages')
--          AND state = 'completed'
```
‚úÖ –ü–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, completedDate —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å—Ö–µ–º–µ

**–í—ã–≤–æ–¥:** ‚úÖ –í—Å–µ 4 —á–∞—Å—Ç–∏ UNION ALL –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã. –ü–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤–æ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö.

---

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 1: –ü–æ–ª–µ `sourceType` vs `type`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í DDL –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö –≤–∏–¥–Ω–æ –ø–æ–ª–µ `type` –≤ —Ç–∞–±–ª–∏—Ü–µ `user_permission_packages`, –Ω–æ –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `sourceType`.

**–†–µ—à–µ–Ω–∏–µ:** 
- –í–æ–∑–º–æ–∂–Ω–æ, `sourceType` - —ç—Ç–æ –∞–ª–∏–∞—Å –∏–ª–∏ –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏
- –í RAW-—Ç–∞–±–ª–∏—Ü–µ ClickHouse –∑–∞–ª–æ–∂–µ–Ω—ã –æ–±–∞ –ø–æ–ª—è
- **–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–∏—Ç—å** —É –∫–æ–º–∞–Ω–¥—ã PostgreSQL, –∫–∞–∫–æ–µ –ø–æ–ª–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ

---

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 2: –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å 'MSK'
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `AT TIME ZONE 'MSK'`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö PostgreSQL.

**–†–µ—à–µ–Ω–∏–µ:**
- –í ClickHouse –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `'Europe/Moscow'`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤ PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `'Europe/Moscow'` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ú–∏–Ω–æ—Ä–Ω–æ–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

---

### ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ 3: –î–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í —Ä–∞–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –¥–∞—Ç—ã:
- `payments`: `>= '2024-01-01'`
- `users`: `>= '2024-01-01'`
- `trial`, `first_pay_tariff`, `first_pay_ap`: `>= '2025-01-01'`
- `churn`: `>= '2024-01-01'`

**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ:
1. –°–æ–±—ã—Ç–∏—è 2024 –≥–æ–¥–∞ –¥–ª—è trial/first_pay —É–∂–µ –Ω–µ –Ω—É–∂–Ω—ã
2. –ì—Ä–∞–Ω–∏—Ü—ã –¥–∞—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã —Å –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–µ—Ä–æ—è—Ç–Ω–æ, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ

---

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ 4: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ `packages-by-period`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç generate_series –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ JOIN —Å –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π.

**–†–µ—à–µ–Ω–∏–µ:**
- –í ClickHouse –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `numbers()` –≤–º–µ—Å—Ç–æ generate_series
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å –ø—Ä–µ–¥–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MATERIALIZED VIEW —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£—á—Ç–µ–Ω–æ –≤ —Å–∫—Ä–∏–ø—Ç–µ ClickHouse (–∑–∞–ø—Ä–æ—Å –≤—ã–Ω–µ—Å–µ–Ω –≤ ETL)

---

## –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–µ–π PostgreSQL ‚Üí ClickHouse

### RAW-—Ç–∞–±–ª–∏—Ü—ã

| PostgreSQL | ClickHouse | –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ |
|------------|------------|----------------|
| `uuid` | `UUID` | 1:1 |
| `timestamptz` | `DateTime` | –ü–æ—Ç–µ—Ä—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞, —Ö—Ä–∞–Ω–∏—Ç—Å—è UTC |
| `varchar(N)` | `String` | 1:1 |
| `numeric(12,2)` | `Decimal(12,2)` | 1:1 |
| `int2` | `Int16` | 1:1 |
| `int4` | `Int32` | 1:1 |
| `bool` | `UInt8` | 0/1 |
| `jsonb` | `String` –∏–ª–∏ `Map(String, String)` | –¢—Ä–µ–±—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ |
| `array` | `Array(String)` | 1:1 |

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### 1. –ü–æ—Ä—è–¥–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –¥–æ –≤—Ç–æ—Ä–Ω–∏–∫–∞:

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ ClickHouse (`mg_raw`, `mg_dm`, `mg_mv`)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å RAW-—Ç–∞–±–ª–∏—Ü—ã (6 —Ç–∞–±–ª–∏—Ü)
3. ‚úÖ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ PostgreSQL (—Ö–æ—Ç—è –±—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å –≤–∏—Ç—Ä–∏–Ω—ã –¥–ª—è `users` –∏ `payments`
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–∏—Ö –¥–≤—É—Ö –≤–∏—Ç—Ä–∏–Ω
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (—Å—Ä–∞–≤–Ω–∏—Ç—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ PostgreSQL)

### 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç—á—ë—Ç–æ–≤:

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ç—á—ë—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ |
|-----------|-------|-----------|-------------------|
| üî• 1 | users | –ü—Ä–æ—Å—Ç–æ–π | ‚úÖ MV –≥–æ—Ç–æ–≤–∞ |
| üî• 2 | payments | –°—Ä–µ–¥–Ω–∏–π | ‚úÖ MV –≥–æ—Ç–æ–≤–∞ |
| üü° 3 | event_backend | –°—Ä–µ–¥–Ω–∏–π | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç ETL |
| üü° 4 | packages-by-tariff | –°–ª–æ–∂–Ω—ã–π | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç ETL |
| üü° 5 | packages-by-period | –û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç ETL |
| üîµ 6 | mg_churn | –û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç ETL |

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏:

**–î–ª—è RAW-—Ç–∞–±–ª–∏—Ü (–µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞):**
```python
# –ü—Ä–∏–º–µ—Ä: Python-—Å–∫—Ä–∏–ø—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º clickhouse-driver
# 1. –í—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ PostgreSQL (–ø–æ updated/created > last_sync_time)
# 2. –í—Å—Ç–∞–≤–∏—Ç—å –≤ ClickHouse RAW-—Ç–∞–±–ª–∏—Ü—ã
# 3. –û–±–Ω–æ–≤–∏—Ç—å last_sync_time
```

**–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–∏—Ç—Ä–∏–Ω (–µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç):**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Airflow DAG
- –ó–∞–ø—É—Å–∫–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –∏–∑ –°–ï–ö–¶–ò–ò 6 —Å–∫—Ä–∏–ø—Ç–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

- –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∑–∞–¥–µ—Ä–∂–∫—É —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ > 1 —á–∞—Å
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫: PostgreSQL vs ClickHouse

---

## –ò—Ç–æ–≥–æ–≤—ã–π –≤–µ—Ä–¥–∏–∫—Ç

### ‚úÖ –ó–ê–ü–†–û–°–´ –ö–û–†–†–ï–ö–¢–ù–´

–í—Å–µ 6 SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ö–µ–º–µ PostgreSQL:
- ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
- ‚úÖ –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- ‚úÖ JOIN-—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–π –ø–æ–Ω—è—Ç–Ω–∞ –∏ —Ä–µ–∞–ª–∏–∑—É–µ–º–∞
- ‚úÖ –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–∏—Ç—å:

1. **sourceType vs type** - –∫–∞–∫–æ–µ –ø–æ–ª–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ PostgreSQL
2. **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å MSK** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. **–ì—Ä–∞–Ω–∏—Ü—ã –¥–∞—Ç** - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å –±–∏–∑–Ω–µ—Å–æ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–æ–≤

### üìã –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

–§–∞–π–ª `clickhouse_mg_reporting_schema.sql` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ç–∞–±–ª–∏—Ü
- ‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ—Ç—á—ë—Ç–æ–≤
- ‚úÖ SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–∏—Ç—Ä–∏–Ω
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ú–æ–∂–Ω–æ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é –≤ ClickHouse!**

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** 2025-11-14  
**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** AI Assistant  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –ü–†–û–î–ê–ö–®–ï–ù–£ (–ø–æ—Å–ª–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è 3 –º–æ–º–µ–Ω—Ç–æ–≤)

